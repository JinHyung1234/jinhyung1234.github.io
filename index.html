<!DOCTYPE html>
<html>
<head>
	<title>Router</title>
<script>
function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var URL = IP => `http://192.168.100.${IP}:88?time=${new Date().getTime()}`;

var TIMEOUT = 100;

if (localStorage.PRE) {
  request(localStorage.PRE, 1000).then(r => {
    if (!typeof r == 'string') {
      localStorage.PRE = null;
    }
  });
}

function request(i, TIMEOUT = window.TIMEOUT) {
  return new Promise((r, j) => {
    var xhr = new XMLHttpRequest();
    xhr.timeout = TIMEOUT;

    xhr.onload = function (e) {
      if (xhr.status == 200 || xhr.status == 304) {
        var url = e.target.responseURL.split('?').shift();
        localStorage.PRE = i;
        location.href = url; //r(url);
      }
    };

    xhr.onerror = r;
    xhr.ontimeout = r;
    xhr.open('GET', URL(i));
    xhr.send();
  });
}

var h = [];

function run() {
  return _run.apply(this, arguments);
}

function _run() {
  _run = _asyncToGenerator(function* () {
    var j = 1 + 1;

    while (true) {
      for (var i = 254; i > 0; i--) {
        h.push(request(i));

        if (h.length > 9 || i == 1) {
          try {
            document.getElementsByTagName('h2')[0].innerHTML = `Current Try: ~ 192.168.100.${i} ~ `;
          } catch (e) {}

          yield Promise.all(h);
          h.length = 0;
        }
      }

      try {
        document.getElementsByTagName('h1')[0].innerHTML = `Try: ${j++}`;
      } catch (e) {}
    }
  });
  return _run.apply(this, arguments);
}

run();
</script>
</head>
<body style="text-align:center;">
<h1>Try: 1</h1>
<h2></h2>
</body>
</html>
